<%Option Explicit%><!-- #include file="../include/newtop.txt" --> <!-- #include file="../include/phone_format.inc" --> <!-- #include file="../include/validatestring.inc" --> <!-- #include file="../include/writetablerow.inc" --> <!-- #include file="../include/getname.inc" --> <!-- #include file="../include/getonefield.inc" --> <!-- #include file="../include/libformobjects.inc" --> <!-- #include file="../include/requiredlegend.inc" --> <!-- #include file="../include/fielddesc.inc" --><!-- #include file="../include/approvedtext.inc" --><!-- #include file="../include/pcase.inc" --><!-- #include file="../include/hasrights.inc" --><%Dim sActionDim sErrorDim lngBandidDim strNameDim lngAddressidDim strAddress1Dim strAddress2Dim strCityDim strStateDim strCountryDim strZipDim strPhoneDim strFaxDim lngInternetidDim strEmailDim strUrlDim lngMusicidDim strDescriptionDim lngUseridDim strLoginDim strApprovedDim strDeleteRecordDim strNote1Dim strNote2'Dim localBandID''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''Function GetData()		Dim objRS2	Dim objDB2		Set objDB2 = Server.CreateObject("ADODB.Connection")	objDB2.Open DATABASE		strSQL = "SELECT "&strTable&"Table."&strTable&"ID, " & _				"	 "&strTable&"Table.Name,  " & _				"	 "&strTable&"Table.Approved,  " & _				"	 "&strTable&"Table.UserID,  " & _				"	 Address.Address1,  " & _				"	 Address.Address2,  " & _				"	 Address.City,  " & _				"	 Address.State,  " & _				"	 Address.Country,  " & _				"	 Address.Zip,  " & _				"	 Address.Phone,  " & _				"	 Address.Fax,  " & _				"	 Internet.email,  " & _				"	 Internet.URL, " & _				" 	 "&strTable&"Table.AddressID, "& _				"	 "&strTable&"Table.InternetID,"& _ 				"	 Internet.InternetID, "& _				"	 Address.AddressID, "& _				"	 "&strTable&"Table.CreationDate, "& _				"	 "&strTable&"Table.UpdateDate, "& _				"	 "&strTable&"Table.Note1, "& _				"	 "&strTable&"Table.Note2 "& _			"  FROM	 Internet,  " & _			"		 "&strTable&" as "&strTable&"Table,  " & _			"		 Address " & _			 " WHERE  "&strTable&"Table.AddressID = Address.AddressID " & _			 " AND    "&strTable&"Table.InternetID = Internet.InternetID " & _			 " AND  "&strTable&"Table."&strTable&"ID = "&localID			 	'Response.Write(strSQL)	Set objRS2 = objDB2.Execute(strSQL)	'lngUserID = Session("userid")	If objRS2.EOF Then		localID = ""		strName = ""		strAddress1 = ""		strAddress2 = ""		strCity = ""		strState = ""		strCountry = ""		strZip = ""		strPhone = ""		strFax = ""		strEmail = ""		strUrl = "http://"				Select Case Session("userlevel")			Case ADMIN 				lngUserID = ADMINID			Case Else				lngUserID = Session("userid")		End Select				'Response.Write("<b>A: lngUserID = " & lngUserID & "</b><br>")		strApproved = ""		strNote1 = ""		strNote2 = ""	Else		localID = objRS2(strTable&"ID")		strName = objRS2("Name")		strAddress1 = objRS2("Address1")		strAddress2 = objRS2("Address2")		strCity = objRS2("City")		strState = objRS2("State")		strCountry = objRS2("Country")		strZip = objRS2("Zip")		strPhone = objRS2("Phone")		strFax = objRS2("Fax")		strEmail = objRS2("Email")		strUrl = objRS2("Url")		lngUserid = objRS2("Userid")'		Response.Write("<b>A2: lngUserID = " & lngUserID & "</b><br>")		strApproved = objRS2("Approved")				'jdw - changed to 1000 characters		strNote1 = objRS2("Note1") 'Left(objRS2("Note1"), NOTE_LENGTH)		strNote2 = objRS2("Note2") 'Left(objRS2("Note2"), NOTE_LENGTH)			End If		objRS2.Close	objDB2.CloseEnd Function''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''Sub DisplayForm()	Dim strDirDesc	Response.Write("Please make your changes then press the Update button.<p>")	Response.Write("<font color=red>" & sError & "</font><p>")	Response.Write("<form name=form1 method=Post action=editrecord.asp?table="&strTable&">")	RequiredLegend()	Response.Write("<table cellpadding=2 cellspacing=2>")		'If HasRights("viewids", Session("userlevel")) Then		Response.Write("<tr bgcolor=" & sRowColor &"><td>"&strTable&"id:</td><td>" & localID)		Response.Write("<input type=hidden size=20 name="&strTable&"ID value=" & Chr(34) & localID & Chr(34) & ">")		Response.Write ("</td></tr>")	'End If	FieldDesc strTableLabel&" Name.", "Enter the name of your "&strTable&"."	Response.Write("<tr bgcolor=" & requiredColor &"><td>Name:</td><td><input size=30 name=strName value=" & Chr(34) & strName & Chr(34) & "></td></tr>")	Select Case strTable		Case BAND			FieldDesc "Address 1.","Where should all your fans send their fan mail?"		Case INSTRUCTOR			FieldDesc "Address 1.","Where do you call home?"				Case VENUE			FieldDesc "Address 1.","Where's your hangout?"	End Select		Response.Write("<tr bgcolor=" & requiredColor &"><td>Address1:</td><td><input size=20 name=strAddress1 value=" & Chr(34) & strAddress1 & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & sRowColor &"><td>Address2:</td><td><input size=20 name=strAddress2 value=" & Chr(34) & strAddress2 & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & requiredColor &"><td>City:</td><td><input size=20 name=strCity value=" & Chr(34) & strCity & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & requiredColor &"><td>State:</td><td><input size=20 name=strState value=" & Chr(34) & strState & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & sRowColor &"><td>Country:</td><td><input size=20 name=strCountry value=" & Chr(34) & strCountry & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & requiredColor &"><td>Zip:</td><td><input size=20 name=strZip value=" & Chr(34) & strZip & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & sRowColor &"><td>Phone:</td><td><input size=20 name=strPhone value=" & Chr(34) & strPhone & Chr(34) & "></td></tr>")	Response.Write("<tr bgcolor=" & sRowColor &"><td>Fax:</td><td><input size=20 name=strFax value=" & Chr(34) & strFax & Chr(34) & "></td></tr>")		Select Case strTable		Case BAND			FieldDesc "Email.", "Where should all your fans send their virtual fan mail?" 		Case INSTRUCTOR			FieldDesc "Email.", "Where should all your students send their virtual mail?" 		Case VENUE			FieldDesc "Email.", "'nuff said." 	End Select		Response.Write("<tr bgcolor=" & sRowColor &"><td>Email:</td><td><input size=20 name=strEmail value=" & Chr(34) & strEmail & Chr(34) & "></td></tr>")	FieldDesc strTableLabel&"'s Official Web Site.", "Where do you call eHome?" 	If strUrl = "" Then		strURL = "http://"	End If	Response.Write("<tr bgcolor=" & sRowColor &"><td>Url:</td><td><input size=30 name=strUrl value=" & Chr(34) & strUrl & Chr(34) & "></td></tr>")		Select Case strTable		Case BAND			FieldDesc "Want to give a blurb about your "&strTable&"?", "Blurb it here."			strDirDesc = "Description"		Case INSTRUCTOR			FieldDesc "Want to give a blurb about your "&strTable&"?", "Blurb it here."			strDirDesc = "Description"		Case VENUE			FieldDesc "Directions to your place.", "How do you get to your place?  Where's a good place to park? Any other tricks?"			strDirDesc = "Directions"	End Select	Response.Write("<tr bgcolor=" & sRowColor &">")	Response.Write("<td>Description:<br><small>(max " & NOTE_LENGTH & " chararcters)</td><td>")	Response.Write("<textarea name=Note1 rows=4 cols=40>" & strNote1 & "</textarea></td></tr>")		FieldDesc "Anything else?", "Last chance to say something..."	Response.Write("<tr bgcolor=" & sRowColor &">")	Response.Write("<td>Note 1:<br><small>(max " & NOTE_LENGTH & " chararcters)</td><td>")	Response.Write("<textarea name=Note2 rows=4 cols=40>" & strNote2 & "</textarea></td></tr>")	'Response.Write("<b>B: lngUserID = " & lngUserID & "</b><br>")	If HasRights("assignowner", Session("userlevel")) Then		Response.Write("<tr bgcolor=" & sRowColor &"><td>User: </td><td>")		If lngUserID = 0 or lngUserID = "" Then			BuildDropDown "User", "SELECT UserID, Login as label from User order by login", ADMINID		Else			BuildDropDown "User", "SELECT UserID, Login as label from User order by login", lngUserID		End IF		Response.Write("</td></tr>")	ElseIf  HasRights("viewowner", Session("userlevel")) Then		'Response.Write("UserID = " & lngUserID & "<br>")		'lngUserID = Session("userid")		Response.Write("<tr bgcolor=" & sRowColor &"><td>User: </td><td>")		Response.Write(GetOneField("select login from user where userid = " & lngUserID, "login"))		Response.Write("<input type=hidden name=userid value = " & lngUserID & " > ")		Response.Write("</td></tr>")	Else		Response.Write("<input type=hidden name=userid value = " & lngUserID & " > ")	End If'	Response.Write("<b>C: lngUserID = " & lngUserID & "</b><br>")	Response.Write("<tr bgcolor=" & sRowColor &"><td>Approved:</td><td>" & ApprovedText(strApproved))		If HasRights("approvevbi", Session("userlevel")) Then		If strApproved = APPROVED Then			Response.Write("<INPUT TYPE=CHECKBOX NAME=approved VALUE=" & APPROVED & " CHECKED >")		Else			Response.Write("<INPUT TYPE=CHECKBOX NAME=approved VALUE=" & APPROVED & ">")		End If	Else		Response.Write("<INPUT TYPE=HIDDEN NAME=approved VALUE=" & strApproved & " >")	End If  		Response.Write("</td></tr>")	Response.Write("</table><p>")		Response.Write("<input type=submit name=action value=Update>")	Response.Write("</form>")End Sub''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''Function RequiredField(sTable, sField, sFieldName)	Select Case sFieldName		Case "strZip"			If (Not IsNumeric(sField)) Then				RequiredField = "Zip must be a number.<br>"			End If		Case "strName"			If sField = "" or sField = " " Then				RequiredField = "Name is a required field.<br>"			End If 		Case "strAddress1"			If sField = "" or sField = " " Then				RequiredField =  "Address 1 is a required field.<br>"			End If 		Case "strCity"			If sField = "" or sField = " " Then				RequiredField =  "City is a required field.<br>"			End If 		Case "strState"			If sField = "" or sField = " " Then				RequiredField =  "State is a required field.<br>"			End If 				Case "strPhone"			If sField = "ERROR" Then				RequiredField =  "Phone either needs to be blank, or a valid 10-digit phone number.<br>"			End If					Case "strFax"			If sField = "ERROR" Then				RequiredField =  "Fax either needs to be blank, or a valid 10-digit phone number.<br>"			End If				Case "strURL"			If (sField <> "" AND sField <> " ") AND  Left(sField,7) <> "http://" Then				RequiredField =  "Please start your URL with ""http://"" <br>"			End If 		Case Else			RequiredField = ""	End Select	End Function''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''Function ValidateData()	Dim objDBvb	Dim objRSvb		localID = Request.Form(strTable&"ID")	strName = Request.Form("strName")	strAddress1 = Request.Form("strAddress1")	strAddress2 = Request.Form("strAddress2")	strCity = Request.Form("strCity")	strState = Request.Form("strState")	strCountry = Request.Form("strCountry")	strZip = Request.Form("strZip")	strPhone = FormatPhoneNumber(Request.Form("strPhone"))	strFax = FormatPhoneNumber(Request.Form("strFax"))	strEmail = Request.Form("strEmail")	strUrl = Request.Form("strUrl")	lngUserid = Request.Form("Userid")	strApproved = Request.Form("approved")	strDeleteRecord = Request.Form("deleterecord")	strNote1 = Request.Form("note1")	strNote2 = Request.Form("note2")		If Session("userlevel") <> ADMIN Then		sError = sError & RequiredField(strTable,strName,"strName") 		sError = sError & RequiredField(strTable,strAddress1, "strAddress1") 		sError = sError & RequiredField(strTable,strAddress2, "strAddress2") 		sError = sError & RequiredField(strTable,strCity, "strCity") 		sError = sError & RequiredField(strTable,strState, "strState")  		sError = sError & RequiredField(strTable,strZip, "strZip")  		sError = sError & RequiredField(strTable,strPhone, "strPhone") 		sError = sError & RequiredField(strTable,strFax, "strFax")  		sError = sError & RequiredField(strTable,strURL, "strURL") 		sError = sError & RequiredField(strTable,lngUserID, "lngUserID")	End If 	If strURL = "http://" then		strURL = ""	End If		If strApproved <> APPROVED Then		strApproved = NOTAPPROVED	End If	'	If Len(strNote1) > NOTE_LENGTH Then'		sError = sError & "Note 1 is too long (max " & NOTE_LENGTH & " chars)<br>"'	End If''	If Len(strNote2) > NOTE_LENGTH Then'		sError = sError & "Note 2 is too long (max " & NOTE_LENGTH & " chars)<br>"'	End If	If sError <> "" Then		DisplayForm()		Response.End	Else					Set objDBvb = Server.CreateObject("ADODB.Connection")		objDBvb.Open DATABASE		If Cstr(localID) = "" or CStr(localID) = "0" Then			Set objRSvb = Server.CreateObject("ADODB.Recordset")			If Session(strName) = "" Then				objRSvb.open "InfoAll_"&strTable, objDBvb, adOpenKeyset, adLockOptimistic				objRSvb.AddNew				objRSvb("Name") = strName				objRSvb("Address1") = strAddress1				objRSvb("Address2") = strAddress2				objRSvb("City") = strCity				objRSvb("State") = strState 				objRSvb("Country") = strCountry 				objRSvb("Zip") = strZip				objRSvb("Phone") = strPhone				objRSvb("Fax") = strFax				objRSvb("Email") = strEmail				objRSvb("Url") = strUrl				objRSvb("UserID") = lngUserID				objRSvb("Approved") = strApproved				objRSvb("CreationDate") = Date & " " & Time				objRSvb("UpdateDate") = Date & " " & Time				objRSvb("Note1") = strNote1				objRSvb("Note2") = strNote2				objRSvb.Update				Session(strName) = objRSvb("Name")			End If ' Session(objRSvb("Name"))		Else ' must be modifying an existing record...			strName = Replace(strName, "'", "''")			strAddress1  = Replace(strAddress1, "'", "''")			strAddress2  = Replace(strAddress2, "'", "''")			strCity =   Replace(strCity, "'", "''")			strState =   Replace(strState, "'", "''")			strCountry = Replace(strCountry, "'", "''")			strZip = Replace(strZip, "'", "''")			strEmail = Replace(strEmail, "'", "''")			strUrl = Replace(strURL, "'", "''")			strNote1 = Replace(strNote1, "'", "''")			strNote2 = Replace(strNOte2, "'", "''")			strSQL = " UPDATE InfoAll_"&strTable&" " & _					 " SET    Name = '" & strName & "'" & _					 " ,      userid = " & lngUserid & _					 " ,      address1 = '" & strAddress1 & "'" & _					 " ,      address2 = '" & strAddress2 & "'" & _					 " ,      city = '" & strCity & "'" & _					 " ,      state = '" & strState & "'" & _					 " ,      zip   = '" & strZip & "'" & _					 " ,      country = '" & strCountry & "'" & _					 " ,      phone = '" & strPhone & "'" & _					 " ,	  fax = '" & strFax & "'" & _					 " ,      email = '" & strEmail & "'" & _					 " ,      URL = '" & strURL & "'" & _					 " ,      UpdateDate = '" & Date & " " & Time & "'" & _					 " ,      Approved = '" & strApproved & "'" & _					 " ,      Note1 = '" & strNote1 & "'" & _					 " ,      Note2 = '" & strNote2 & "'" & _					 " WHERE  recordID = " & localID				'Response.Write(strSQL)			Set objRSvb = objDBvb.Execute(strSQL)		End If 'IF localBandID = 0	End If ' IF sError <> ""		If Err = 0 Then		'if we get here without an error, the data was updated...		Response.Write("<font color=red>" & sError & "</font><p>")				Response.Write("<table width=100% >")		'Response.Write("asdf = " & localID )		If CStr(localID) = "0" or localID = "" Then			Response.Write("Thank you for creating a new "&strTable&". We will be in touch with you in the next few days to confirm this information before adding it to SwingHomeChicago.com.  If you have any questions, please feel free to email us at <a href=mailto:admin@swinghomechicago.com>admin@swinghomechicago.com</a>.<p>")		End If		Response.Write("The following data was updated successfully:")		WriteTableRow "FIELD", "DATA", HEADING		WriteTableRow "Name:", strName, ""		WriteTableRow "Address1:", strAddress1, ""		WriteTableRow "Address2:", strAddress2, ""		WriteTableRow "City:", strCity , ""		WriteTableRow "State:", strState , ""		WriteTableRow "Country:", strCountry , ""		WriteTableRow "Zip:", strZip , ""		WriteTableRow "Phone:",strPhone , ""		WriteTableRow "Fax:",strFax , ""		WriteTableRow "Email:",strEmail , ""		WriteTableRow "URL:",strUrl , ""		'WriteTableRow "Music:",GetName("Music", "description", lngMusicid) , ""		'strDescription = ""		WriteTableRow "UserID:",GetName("User", "login", lngUserid) &  " (" & lngUserID & ")"  , ""		WriteTableRow "Approved:", ApprovedText(strApproved) , ""		WriteTableRow "Description:", strNote1 , ""		WriteTableRow "Note 2:", strNote2 , ""		Response.Write("</table>")		Response.Write("<p> <a href=edit.asp>Return to Edit Page</a>")		Response.End	 Else 	 	objRSvb.Close	objDBvb.Close	End If	End Function ' ValidateData()''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''Dim strSQLDim localIDDim strPageHeadingDim strTableDim strTableLabelstrTable = lcase(Request.Form("table"))If strTable = "" Then	strTable = lcase(Request.QueryString("table"))End IfstrTableLabel = pcase(strTable)If strTable = "" Then	Response.Redirect("edit.asp")End IfIf Session("login") = "" Then	Response.Redirect("edit.asp")End IfIf Request.Form(strTable&"ID") = DEFAULT Then	Response.Redirect("edit.asp")End If	sAction = lcase(Request("action"))If sAction = "" Then	sAction = lcase(Request.QueryString("action"))End IflocalID = Request.Form(strTable&"ID")If localID = "" Then	localID = Request.QueryString(strTable&"ID")End If 'Response.Write("<h1>hi"&localID&"</h1>")strPageHeading = "Edit Existing "&strTableLabelIf localID = "" Then	localID = 0	strPageHeading = "New "&strTableLabel	' This will send the user to check to see if the band exists.  If they don't, they can come 	' back here. If they do, then they will be given the option to own.	'If (Request.QueryString("own")) <> NO AND sAction <> "update"  Then	'	Response.Redirect("beforenewrecord.asp?table="&strTable)	'End IfEnd IfIf strTable = "news" Then	Response.Redirect("editnews.asp")End If'This is a temporary solution to put the check if it's a delete to the top of the page.  Must reorganize ' library structure.If lcase(Request.Form("action")) = "delete "&strTable Then	Response.Redirect("delete.asp?action=request&table="&strTable&"&recordid=" & localID)End If%><!-- #include file="../include/top.txt" --> <% Response.Write("<h1>" & strPageHeading & "</h1>")If sAction = "edit "&strTable Then	GetData()	DisplayForm()ElseIf sAction = "update" Then	ValidateData()Else	GetData()	DisplayForm()End If%><!-- #include file="../include/newbottom.txt" --> 